<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área de Socios - Filá Mariscales</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="assets/css/style.css?v=2.0" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-shield-alt me-2"></i>
                Filá Mariscales
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="socios.html"><i class="fas fa-user-friends me-1"></i>Socios</a></li>
                    <li class="nav-item">
                        <a class="nav-link" href="chat.html">
                            <i class="fas fa-comments me-1"></i>Chat
                            <span class="badge bg-danger ms-1 d-none" id="chat-badge">0</span>
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white small me-3" id="user-info">
                    <i class="fas fa-user-circle me-2"></i><span id="user-email">Cargando...</span>
                    <span class="badge bg-secondary ms-2" id="user-role"></span>
                </div>
                <button id="btnLogout" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i>Salir
                </button>
            </div>
        </div>
    </nav>

    <main class="container" style="margin-top: 90px;">
        <div id="access-alert" class="alert alert-danger d-none" role="alert"></div>

        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3">Área privada para Socios</h1>
                <p class="text-muted mb-0">Contenido exclusivo para miembros de la Filá y administradores.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-bullhorn text-primary me-2"></i>
                        Comunicados Internos
                    </div>
                    <div class="card-body" id="comunicados-container">
                        <div class="text-muted">No hay comunicados disponibles.</div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-calendar-check text-primary me-2"></i>
                        Próximas Actividades
                    </div>
                    <div class="card-body" id="actividades-container">
                        <div class="text-muted">Cargando actividades...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-id-card text-primary me-2"></i>
                        Mi Perfil
                    </div>
                    <div class="card-body">
                        <div class="mb-2"><strong>Nombre:</strong> <span id="profile-name">-</span></div>
                        <div class="mb-2"><strong>Email:</strong> <span id="profile-email">-</span></div>
                        <div class="mb-2"><strong>Rol:</strong> <span id="profile-role">-</span></div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-comments text-primary me-2"></i>
                        Chat interno
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Habla con otros socios o abre privados.</p>
                        <a href="chat.html" class="btn btn-outline-primary w-100">
                            <i class="fas fa-comments me-2"></i>Abrir chat
                            <span class="badge bg-danger ms-2 d-none" id="chat-badge-card">0</span>
                        </a>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-download text-primary me-2"></i>
                        Descargas para Socios
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><i class="fas fa-file-pdf text-danger me-2"></i><a href="#">Estatutos (PDF)</a></li>
                            <li class="mb-2"><i class="fas fa-file-word text-primary me-2"></i><a href="#">Reglamento (DOCX)</a></li>
                            <li class="mb-2"><i class="fas fa-image text-success me-2"></i><a href="#">Logotipos (ZIP)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Filá Mariscales</h5>
                    <p class="mb-0">Caballeros Templarios de Elche</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="social-links">
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 Realizado por: Eduardo Santa Cruz</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function checkSession() {
            try {
                const resp = await fetch('api/auth.php?action=check');
                const data = await resp.json();
                if (!data.success) {
                    document.getElementById('access-alert').textContent = 'Acceso restringido. Inicia sesión como socio o administrador.';
                    document.getElementById('access-alert').classList.remove('d-none');
                    setTimeout(() => { window.location.href = 'socios.html'; }, 1500);
                    return null;
                }
                return data.data;
            } catch (e) {
                document.getElementById('access-alert').textContent = 'Error verificando sesión.';
                document.getElementById('access-alert').classList.remove('d-none');
                return null;
            }
        }

        async function loadPrivateContent() {
            const session = await checkSession();
            if (!session) return;

            // Mostrar usuario
            document.getElementById('user-email').textContent = session.email;
            document.getElementById('user-role').textContent = session.role;
            document.getElementById('profile-email').textContent = session.email;
            document.getElementById('profile-role').textContent = session.role;

            // Opcional: nombre si está disponible
            // Se podría ampliar el endpoint para devolver nombre

            // Cargar actividades desde eventos
            try {
                const resp = await fetch('data/eventos.json');
                const eventos = await resp.json();
                const proximos = eventos.slice(0, 5).map(e => `
                    <div class="d-flex justify-content-between align-items-start border-bottom py-2">
                        <div>
                            <div class="fw-semibold">${e.titulo}</div>
                            <small class="text-muted">${e.descripcion}</small>
                        </div>
                        <span class="badge bg-primary">${new Date(e.fecha).toLocaleDateString('es-ES')}</span>
                    </div>
                `).join('');
                document.getElementById('actividades-container').innerHTML = proximos || '<div class="text-muted">No hay próximas actividades.</div>';
            } catch (e) {
                document.getElementById('actividades-container').innerHTML = '<div class="text-muted">No se pudieron cargar las actividades.</div>';
            }

            // Comunicados (placeholder)
            document.getElementById('comunicados-container').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Bienvenido al área privada. Próximamente añadiremos comunicados oficiales.
                </div>
            `;
            // Iniciar contador de no leídos del chat
            try {
                await updateChatNotifications();
                setInterval(updateChatNotifications, 7000);
            } catch (e) {}
        }

        async function updateChatNotifications() {
            try {
                const resp = await fetch('api/chat.php?action=getNotifications', { credentials: 'include' });
                const data = await resp.json();
                if (data && data.success) {
                    const n = (data.data && data.data.private_unread) ? data.data.private_unread : 0;
                    const badge1 = document.getElementById('chat-badge');
                    const badge2 = document.getElementById('chat-badge-card');
                    [badge1, badge2].forEach(b => {
                        if (!b) return;
                        b.textContent = n;
                        if (n > 0) b.classList.remove('d-none'); else b.classList.add('d-none');
                    });
                }
            } catch (e) {
                // ignorar errores de red
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadPrivateContent();

            document.getElementById('btnLogout').addEventListener('click', async function() {
                try {
                    await fetch('api/auth.php?action=logout');
                } catch (e) {}
                window.location.href = 'socios.html';
            });
        });
    </script>
</body>
</html>


